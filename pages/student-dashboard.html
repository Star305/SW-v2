              <canvas id="performanceChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Performance History Section -->
      <section id="performance" class="section" style="display: none;">
        <div class="container">
          <div class="section-title">
            <h2>Performance History</h2>
            <p>Track your academic progress over time</p>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Historical Performance</h3>
              <button class="btn btn-secondary" onclick="exportPerformancePDF()">
                <i class="fas fa-download btn-icon"></i> Download Report
              </button>
            </div>
            
            <div id="performanceHistoryContainer" class="p-4">
              <p>Loading performance history...</p>
            </div>
            
            <div class="chart-container">
              <canvas id="overallPerformanceChart"></canvas>
            </div>
            
            <div id="analyticsMessage" class="alert alert-info mt-4" style="display: none;"></div>
          </div>
        </div>
      </section>

      <!-- Chat with AI Section -->
      <section id="chat" class="section" style="display: none;">
        <div class="container">
          <div class="section-title">
            <h2>Chat with AI Assistant</h2>
            <p>Get instant help with your academic questions</p>
          </div>
          
          <div class="card">
            <div id="chatContainer" class="p-4">
              <div class="text-center py-5">
                <i class="fas fa-robot fa-4x text-primary mb-3"></i>
                <h4>AI Learning Assistant</h4>
                <p class="text-muted">Start a conversation with our AI assistant to get help with your studies.</p>
                <button class="btn btn-primary mt-3" id="startChatBtn">
                  <i class="fas fa-comments btn-icon"></i> Start Chat
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Updates Section -->
      <section id="updates" class="section" style="display: none;">
        <div class="container">
          <div class="section-title">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2>School Updates</h2>
                <p>Latest announcements and notices</p>
              </div>
              <button class="btn btn-outline" id="markAllReadBtn">
                <i class="fas fa-check-circle btn-icon"></i> Mark All as Read
              </button>
            </div>
          </div>
          
          <div class="card">
            <div id="updatesList" class="p-4">
              <div class="notice-card">
                <h4 class="notice-title">Loading updates...</h4>
                <p>Please wait while we fetch the latest updates.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Report Section -->
      <section id="report" class="section" style="display: none;">
        <div class="container">
          <div class="section-title">
            <h2>Send Report</h2>
            <p>Submit reports or issues to school administration</p>
          </div>
          
          <div class="card">
            <div class="p-4">
              <form id="reportForm">
                <div class="form-group">
                  <label class="form-label" for="reportType">Report Type</label>
                  <select class="form-control" id="reportType">
                    <option value="academic">Academic Concern</option>
                    <option value="technical">Technical Issue</option>
                    <option value="feedback">General Feedback</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="reportSubject">Subject</label>
                  <input type="text" class="form-control" id="reportSubject" placeholder="Enter subject">
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="reportMessage">Message</label>
                  <textarea class="form-control" id="reportMessage" rows="5" placeholder="Enter your message"></textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="reportAttachment">Attachment (Optional)</label>
                  <input type="file" class="form-control" id="reportAttachment">
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">
                  <i class="fas fa-paper-plane btn-icon"></i> Send Report
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="social-links">
          <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
          <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
          <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
        </div>
        <p class="mt-3">&copy; 2025 St. Mary's High School. All rights reserved.</p>
        <p class="text-muted small mt-2">Version 2.0.0</p>
      </div>
    </footer>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </div>

    <!-- Hidden File Input for Profile Pic Update -->
    <input type="file" id="file-input" accept="image/*" style="display:none;" />

    <!-- Firebase and App Scripts -->
    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { 
        getAuth, 
        signOut, 
        onAuthStateChanged, 
        sendPasswordResetEmail 
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        updateDoc, 
        collection, 
        query, 
        orderBy, 
        getDocs, 
        limit, 
        arrayUnion, 
        where 
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAR9J2Wz7Eu8dXRzDG8JNHcymLCUQUPJRo",
        authDomain: "deee-9ab53.firebaseapp.com",
        projectId: "deee-9ab53",
        storageBucket: "deee-9ab53.appspot.com",
        messagingSenderId: "399732664479",
        appId: "1:399732664479:web:b84ac30e8266cc51761aaa",
        measurementId: "G-524ZPBX42B"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // DOM Elements
      const menuBtn = document.getElementById('menuBtn');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const mainContent = document.getElementById('mainContent');
      const themeToggle = document.getElementById('themeToggle');
      const sections = document.querySelectorAll('section');
      const navLinks = document.querySelectorAll('.sidebar-link');
      
      // Toggle Sidebar
      menuBtn.addEventListener('click', () => {
        sidebar.classList.add('active');
        overlay.classList.add('active');
        mainContent.classList.add('expanded');
      });

      // Close Sidebar
      overlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        mainContent.classList.remove('expanded');
      });

      // Theme Toggle
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        themeToggle.innerHTML = document.body.classList.contains('dark-mode') ? 
          '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      });

      // Set initial theme
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }

      // Navigation
      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Hide all sections
          sections.forEach(section => {
            section.style.display = 'none';
          });
          
          // Show selected section
          const target = link.getAttribute('href').substring(1);
          document.getElementById(target).style.display = 'block';
          
          // Update active link
          navLinks.forEach(navLink => {
            navLink.classList.remove('active');
          });
          link.classList.add('active');
          
          // Close sidebar on mobile
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          mainContent.classList.remove('expanded');
          
          // Load section-specific content
          switch(target) {
            case 'dashboard':
              loadDashboard();
              break;
            case 'profile':
              loadProfile();
              break;
            case 'results':
              loadResults();
              break;
            case 'performance':
              loadPerformanceHistory();
              break;
            case 'updates':
              loadUpdates();
              break;
          }
        });
      });

      // Utility Functions
      function showMessage(message, type = 'success') {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: type,
          title: message,
          showConfirmButton: false,
          timer: 3000
        });
      }

      function capitalize(str) {
        return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
      }

      // Dashboard Functions
      function loadDashboard() {
        // This would be populated from Firebase
        console.log('Loading dashboard data...');
      }

      // Profile Functions
      function loadProfile() {
        // This would be populated from Firebase
        console.log('Loading profile data...');
      }

      // Results Functions
      function loadResults() {
        // This would be populated from Firebase
        console.log('Loading results data...');
      }

      // Performance History Functions
      function loadPerformanceHistory() {
        // This would be populated from Firebase
        console.log('Loading performance history...');
      }

      // Updates Functions
      function loadUpdates() {
        // This would be populated from Firebase
        console.log('Loading updates...');
      }

      // Export to PDF Functions
      window.exportPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add report card content to PDF
        doc.text('St. Mary\'s High School - Report Card', 14, 15);
        doc.text(`Name: ${document.getElementById('reportName').textContent}`, 14, 25);
        doc.text(`Term: ${document.getElementById('reportTerm').textContent} ${document.getElementById('reportYear').textContent}`, 14, 35);
        
        // Add table
        const rows = [];
        document.querySelectorAll('#reportCardBody tr').forEach(tr => {
          const row = [];
          tr.querySelectorAll('td').forEach(td => {
            row.push(td.textContent);
          });
          rows.push(row);
        });
        
        doc.autoTable({
          head: [['Subject', 'Marks', 'Grade', 'Performance']],
          body: rows,
          startY: 45,
        });
        
        doc.save('report_card.pdf');
      };

      window.exportPerformancePDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.text('St. Mary\'s High School - Performance History', 14, 15);
        
        // Add performance history content
        const history = document.getElementById('performanceHistoryContainer').textContent;
        doc.text(history, 14, 25);
        
        doc.save('performance_history.pdf');
      };

      // Initialize the app when DOM is loaded
      document.addEventListener('DOMContentLoaded', () => {
        // Show dashboard by default
        document.getElementById('dashboard').style.display = 'block';
        
        // Check auth state
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            console.log('User is signed in:', user.email);
            
            // Load user data
            loadUserData(user.email);
          } else {
            // User is signed out
            window.location.href = '/login';
          }
        });
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          window.location.href = '/login';
        } catch (error) {
          console.error('Error signing out:', error);
          showMessage('Error signing out', 'error');
        }
      });

      // Load user data from Firestore
      async function loadUserData(email) {
        try {
          const docRef = doc(db, 'students', email);
          const docSnap = await getDoc(docRef);
          
          if (docSnap.exists()) {
            const userData = docSnap.data();
            
            // Update UI with user data
            document.getElementById('welcomeMessage').textContent = `Welcome, ${capitalize(userData.firstname || 'Student')}`;
            document.getElementById('name').value = userData.firstname || '';
            document.getElementById('surname').value = userData.surname || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('phone').value = userData.phone || '';
            document.getElementById('dob').value = userData.dob || '';
            document.getElementById('gender').value = userData.gender || 'male';
            document.getElementById('address').value = userData.address || '';
            document.getElementById('parent-name').value = userData.parentName || '';
            document.getElementById('parent-phone').value = userData.parentPhone || '';
            document.getElementById('healthIssues').value = userData.healthIssues || '';
            document.getElementById('additionalInfo').value = userData.additionalInfo || '';
            document.getElementById('form').value = userData.form || '';
            document.getElementById('stream').value = userData.stream || '';
            
            if (userData.profilePic) {
              document.getElementById('profilePic').src = userData.profilePic;
              document.getElementById('smallProfilePic').src = userData.profilePic;
            }
            
            if (userData.form && userData.stream) {
              document.getElementById('currentGrade').textContent = `${userData.form} ${userData.stream}`;
            }
            
            if (userData.attendance) {
              document.getElementById('attendanceProgress').style.width = `${userData.attendance}%`;
              document.getElementById('attendanceText').textContent = `Attendance: ${userData.attendance}%`;
            }
          } else {
            console.log('No user data found');
          }
        } catch (error) {
          console.error('Error loading user data:', error);
          showMessage('Error loading user data', 'error');
        }
      }

      // Save profile changes
      document.getElementById('saveChangesBtn').addEventListener('click', async () => {
        const saveBtn = document.getElementById('saveChangesBtn');
        const user = auth.currentUser;
        
        if (!user) return;
        
        try {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> Saving...';
          
          const userData = {
            firstname: document.getElementById('name').value.trim(),
            surname: document.getElementById('surname').value.trim(),
            email: user.email,
            phone: document.getElementById('phone').value.trim(),
            dob: document.getElementById('dob').value,
            gender: document.getElementById('gender').value,
            address: document.getElementById('address').value.trim(),
            parentName: document.getElementById('parent-name').value.trim(),
            parentPhone: document.getElementById('parent-phone').value.trim(),
            healthIssues: document.getElementById('healthIssues').value.trim(),
            additionalInfo: document.getElementById('additionalInfo').value.trim(),
            form: document.getElementById('form').value,
            stream: document.getElementById('stream').value,
            lastUpdated: new Date().toISOString()
          };
          
          await setDoc(doc(db, 'students', user.email), userData, { merge: true });
          showMessage('Profile updated successfully!');
          
          // Update welcome message and grade display
          document.getElementById('welcomeMessage').textContent = `Welcome, ${capitalize(userData.firstname)}`;
          if (userData.form && userData.stream) {
            document.getElementById('currentGrade').textContent = `${userData.form} ${userData.stream}`;
          }
        } catch (error) {
          console.error('Error saving profile:', error);
          showMessage('Error saving profile', 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-save btn-icon"></i> Save Changes';
        }
      });

      // Reset password
      document.getElementById('changePasswordBtn').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        
        try {
          await sendPasswordResetEmail(auth, user.email);
          showMessage('Password reset email sent. Please check your inbox.');
        } catch (error) {
          console.error('Error sending reset email:', error);
          showMessage('Error sending reset email', 'error');
        }
      });

      // Profile picture upload
      document.getElementById('profilePicInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const uploadProgress = document.getElementById('uploadProgress');
        
        uploadProgress.style.display = 'block';
        
        reader.onload = async (event) => {
          const base64Image = event.target.result;
          const user = auth.currentUser;
          
          if (!user) return;
          
          try {
            // Update Firestore
            await updateDoc(doc(db, 'students', user.email), {
              profilePic: base64Image
            });
            
            // Update UI
            document.getElementById('profilePic').src = base64Image;
            document.getElementById('smallProfilePic').src = base64Image;
            showMessage('Profile picture updated!');
          } catch (error) {
            console.error('Error updating profile picture:', error);
            showMessage('Error updating profile picture', 'error');
          } finally {
            uploadProgress.style.display = 'none';
          }
        };
        
        reader.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
          }
        };
        
        reader.readAsDataURL(file);
      });

      // Small profile picture click
      document.getElementById('smallProfilePic').addEventListener('click', () => {
        document.getElementById('profilePicInput').click();
      });
    </script>
  </body>
</html>
